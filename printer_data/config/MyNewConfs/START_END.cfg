[gcode_macro START_PRINT]
description: Preheat, home, adaptive bed mesh (native), park & wait
# Übergabe aus Slicer (alle optional mit Defaults):
#  BED=<°C>           (Default 60)
#  EXTRUDER=<°C>      (Default 200)
#  PREHEAT_NOZZLE=<°C> (Default 150, Anti-Ooze)
#  ADAPTIVE=1/0       (Default 1 = an)
#  ADAPTIVE_MARGIN=<mm> (Default 3)
#  PARK_X/PARK_Y/PARK_Z (überschreibt Client-Variablen)
gcode:
    {% set bed     = params.BED|default(60)|float %}
    {% set noz     = params.EXTRUDER|default(200)|float %}
    {% set pre     = params.PREHEAT_NOZZLE|default(150)|float %}
    {% set adaptive= params.ADAPTIVE|default(1)|int %}
    {% set margin  = params.ADAPTIVE_MARGIN|default(3)|float %}

    # Parkposition – nimm _CLIENT_VARIABLE, falls vorhanden
    {% set has_client = ('gcode_macro _CLIENT_VARIABLE') in printer %}
    {% set park_x_def = has_client and printer['gcode_macro _CLIENT_VARIABLE'].variable_custom_park_x or 5.0 %}
    {% set park_y_def = has_client and printer['gcode_macro _CLIENT_VARIABLE'].variable_custom_park_y or 5.0 %}
    {% set park_dz    = has_client and printer['gcode_macro _CLIENT_VARIABLE'].variable_custom_park_dz or 2.0 %}
    {% set park_x = (params.PARK_X|float) if ('PARK_X' in params) else park_x_def|float %}
    {% set park_y = (params.PARK_Y|float) if ('PARK_Y' in params) else park_y_def|float %}
    {% set park_z = (params.PARK_Z|float) if ('PARK_Z' in params) else park_dz|float %}

    # Vorheizen (Anti-Ooze)
    M117 Preheating...
    SET_HEATER_TEMPERATURE HEATER=bed TARGET={bed}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={pre}

    G90
    M83
    M117 Homing...
    G28
    G0 Z{max(park_z, 5.0)} F1200

    BED_MESH_CLEAR
    # Prüfen, ob Object-Daten vorhanden sind (Exclude Object lädt sie aus dem G-Code)
    {% set obj_mod = 'exclude_object' in printer %}
    {% set have_objs = obj_mod and (printer.exclude_object.objects|length > 0) %}

    {% if adaptive and have_objs %}
      M117 Adaptive mesh...
      BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN={margin}
    {% else %}
      M117 Full-bed mesh...
      BED_MESH_CALIBRATE
    {% endif %}

    # Parken und auf Ziel-Temps warten
    M117 Parking...
    G0 X{park_x} Y{park_y} F6000
    G0 Z{park_z} F1200

    M117 Heating to targets...
    M140 S{bed}
    M104 S{noz}
    M190 S{bed}
    M109 S{noz}
    M117 Ready
